# Red Hat Satellite Capsule Installation Automation

## Overview

This project automates the installation of Red Hat Satellite Capsule servers using certificate tarballs and installation instructions generated by the satellite-install-6_10 project. The automation includes sophisticated host gatekeeping to ensure proper task isolation between Satellite and Capsule servers.

## Architecture Design Philosophy

### Why Mixed Host Execution?

This automation uses a unique architecture where both Satellite and Capsule hosts participate in the same playbook execution. Here's why:

1. **API Operations Requirement**: We use the `redhat.satellite` collection to verify Capsule registration status, which must execute on the Satellite server
2. **Installation Tasks**: Actual Capsule installation must only run on Capsule servers
3. **AAP Integration**: Designed for Ansible Automation Platform where we want single-job execution
4. **Cross-Host Verification**: Enables real-time verification of Capsule registration from both perspectives

### The Gatekeeping System

To safely handle mixed host execution, we implement a multi-layer gatekeeping system. Every host that enters the playbook goes through host classification, where it's identified as either SATELLITE, CAPSULE, or UNAUTHORIZED. The playbook immediately rejects any unauthorized hosts and creates an execution plan for valid hosts. Satellite hosts only perform API operations while Capsule hosts run installation tasks. This ensures complete isolation of operations based on host type.

## Prerequisites

### From Parent Project (satellite-install-6_10)
Each Capsule must have these files already distributed:
- `/root/capsule_cert/<capsule_fqdn>-certs.tar` - Certificate tarball with OAuth keys
- `/root/capsule_cert/<capsule_fqdn>-install.txt` - Installation instructions

### Satellite Requirements
- **Activation Key**: `satellite-infrastructure` must exist with appropriate content view
- **Organization**: Must match the `satellite_org` variable
- **API Access**: Credentials for `redhat.satellite` collection operations

### Infrastructure Requirements
- **RHEL 9.x** on all servers
- **20GB+ RAM** per server
- **Direct network connectivity** between Satellite and Capsules (no proxy for registration)
- **DNS resolution** working in both directions

## How It Works

### 1. Host Classification Phase
Every host that enters the playbook is immediately classified:
- **SATELLITE**: The single Satellite server (matches `satellite_fqdn`)
- **CAPSULE**: Valid Capsule servers (listed in `capsule_fqdns`)
- **UNAUTHORIZED**: Any other host (immediately rejected)

### 2. Execution Planning
Based on classification, the playbook determines what operations each host will perform:
- **Satellite Host**: API verification only, no installation tasks
- **Capsule Hosts**: Full installation workflow if not already installed

### 3. Role Execution (Capsules Only)
All roles include gatekeeping conditions:
```yaml
when: 
  - is_capsule_host  # GATEKEEPER CHECK
  - will_install_capsule | default(false)
```

### 4. Post-Task Isolation
Post-tasks are segregated by host type:
- **Satellite tasks**: API checks, registration verification
- **Capsule tasks**: Service verification, local API checks
- **Cross-verification**: Capsules delegate to Satellite for registration confirmation

## Workflow Execution Flow

The playbook executes in four distinct phases, each with specific gatekeeping controls:

**Phase 1: Pre-Tasks and Host Classification**
The playbook starts by classifying every host as either SATELLITE, CAPSULE, or UNAUTHORIZED. Any unauthorized host immediately fails with a clear error message. Valid hosts receive their role assignment and the playbook sets facts like `is_satellite_host` and `is_capsule_host` that control all subsequent operations.

**Phase 2: Host-Specific Validation**
Satellite hosts verify API connectivity and retrieve the current list of registered Capsules from the Satellite API. Meanwhile, Capsule hosts check for required certificate files, validate system requirements, verify DNS resolution to the Satellite, and determine if they're already installed or need installation.

**Phase 3: Capsule Installation (Capsules Only)**
Only Capsule hosts that need installation proceed through the five installation roles. Each role is protected by gatekeeping conditions that verify the host is a Capsule and needs installation. The roles execute in sequence: registration preparation, Satellite registration, repository configuration, instruction parsing, and finally Capsule installation.

**Phase 4: Post-Installation Verification**
After installation, Capsule hosts verify their services are running and test their local API endpoints. The Satellite host checks that all Capsules appear in the Satellite API. Finally, each Capsule delegates a verification check to the Satellite to confirm registration from both perspectives.

## Configuration

### Environment-Specific Variables

The automation supports multiple environments through separate variable files in group_vars: all.yml for Development, test_env.yml for Test, prod_env.yml for Production, and ead_env.yml for EAD environment.

### Key Configuration Variables

```yaml
# Satellite Configuration
satellite_fqdn: "satellite.example.com"
satellite_server_url: "https://{{ satellite_fqdn }}"

# Capsule Configuration  
capsule_fqdns:
  - capsule1.example.com
  - capsule2.example.com

# Load Balancer Support
loadbalanced_capsules:
  - capsule1.example.com
capsule_loadbalancer_fqdn: "lb.example.com"

# Registration Settings
capsule_activation_key: "satellite-infrastructure"
capsule_force_registration: true
capsule_enable_remote_execution: true
```

## Usage

### Running in AAP

1. **Create Project**: Link to this Git repository
2. **Create Inventory**: Must include BOTH Satellite and Capsule hosts
3. **Configure Credentials**:
   - Machine credential for SSH access
   - Custom credential with Satellite API credentials
4. **Create Job Template**:
   - Select appropriate playbook for environment
   - Enable privilege escalation
5. **Launch Job**: Single execution handles all hosts correctly

### Playbook Selection

Choose the playbook based on your target environment:
- `capsule-install.yml` - Development environment (default)
- `capsule-install-test.yml` - Test environment
- `capsule-install-prod.yml` - Production environment
- `capsule-install-ead.yml` - EAD environment

### Example AAP Inventory

```yaml
all:
  children:
    satellite:
      hosts:
        satellite.example.com:
    capsules:
      hosts:
        capsule1.example.com:
        capsule2.example.com:
```

**Important**: Both Satellite and Capsule hosts MUST be in the inventory for the playbook to function correctly.

## Gatekeeping Safety Features

### Protection Layers

1. **Host Classification**: Immediate identification and validation
2. **Unauthorized Rejection**: Non-listed hosts fail immediately
3. **Role Guards**: Every role has `is_capsule_host` condition
4. **Task Isolation**: All tasks check host type before execution
5. **Block Separation**: Satellite and Capsule operations in separate blocks

### Example Gatekeeping in Action

```yaml
# This task will ONLY run on Capsule hosts
- name: Install Capsule packages
  when: 
    - is_capsule_host           # Must be a Capsule
    - will_install_capsule      # Must need installation
  ansible.builtin.dnf:
    name: satellite-capsule
    state: present

# This task will ONLY run on the Satellite host  
- name: Check Capsule registration status
  when: is_satellite_host       # Must be Satellite
  redhat.satellite.capsule_info:
    name: "{{ item }}"
  loop: "{{ capsule_fqdns }}"
```

## Troubleshooting

### Common Issues

**"UNAUTHORIZED HOST DETECTED"**
- Host is not in `satellite_fqdn` or `capsule_fqdns` list
- Check your group_vars configuration
- Verify inventory hostname matches exactly

**Tasks running on wrong host type**
- Check gatekeeping conditions are in place
- Verify `is_satellite_host` and `is_capsule_host` facts are set
- Look for missing `when` conditions

**Delegation failures**
- Ensure Satellite host is in inventory
- Check SSH connectivity between hosts
- Verify `delegate_to: "{{ satellite_fqdn }}"` is correct

**Certificate files not found**
- Verify satellite-install project completed successfully
- Check files exist at `/root/capsule_cert/`
- Ensure filenames match the Capsule FQDN exactly

## Design Decisions

### Why Not Separate Playbooks?

We could have created separate playbooks for Satellite and Capsule operations, but chose mixed execution because:

1. **Single Job Simplicity**: One AAP job template handles everything
2. **Real-time Verification**: Can check registration immediately after installation
3. **Unified Reporting**: Single execution provides complete status
4. **Reduced Complexity**: No need for workflow coordination

### Why Gatekeeping Over Host Groups?

While we could use `hosts: capsules`, the gatekeeping approach provides:

1. **Explicit Safety**: Every task explicitly checks authorization
2. **Clear Audit Trail**: Easy to see why tasks run or skip
3. **Flexible Operations**: Can add Satellite-specific features easily
4. **Delegation Support**: Cross-host operations work naturally

### Why No Proxy for Registration?

Capsule registration must be direct to Satellite because:

1. **Security**: Direct connection ensures secure OAuth key exchange
2. **Reliability**: Eliminates proxy as potential failure point
3. **Simplicity**: Reduces configuration complexity
4. **Performance**: Direct connection is faster for large certificate transfers

## Security Considerations

- **No Proxy for Registration**: Direct connection ensures secure registration
- **API Credentials**: Managed through AAP, never stored in code
- **Certificate Protection**: OAuth keys protected in installation files
- **Host Validation**: Unauthorized hosts cannot execute any tasks
- **Idempotency**: Safe to re-run without breaking existing installations

## Load Balancer Support

The automation fully supports load-balanced Capsule configurations:

1. **Automatic Detection**: Identifies which Capsules are load-balanced from `loadbalanced_capsules` list
2. **Certificate Requirements**: Ensures certificates include both Capsule FQDN and load balancer FQDN
3. **Special Parameters**: Automatically adds `--certs-cname` and remote execution parameters
4. **Clear Instructions**: Generated installation files include load balancer-specific guidance

## Future Enhancements

- Post-installation Capsule configuration automation
- Automated content synchronization setup
- Load balancer pool management
- Health check monitoring integration
- Automated certificate renewal workflow
- Capsule performance tuning automation

## Support

For issues or questions:
1. Check the execution plan output for host classification
2. Verify gatekeeping conditions in task output
3. Review delegation results for cross-host operations
4. Consult Red Hat Satellite 6.17 documentation
5. Check role-specific output for detailed error messages

---

*This automation implements defense-in-depth gatekeeping to ensure reliable, safe mixed-host execution in enterprise environments.*