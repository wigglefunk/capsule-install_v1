# Red Hat Satellite Capsule Installation Automation

## Overview

This project automates the installation of Red Hat Satellite Capsule servers using certificate tarballs and installation instructions generated by the companion satellite install project. It completes the full automation chain by reading distributed certificate files, registering Capsules to their respective Satellite servers, and executing the installation with proper load balancer support.

## Project Purpose

The satellite install project handles Satellite server installation and prepares Capsule servers by distributing certificate tarballs and installation instructions to each Capsule. However, it stops short of actually installing the Capsule software. This project picks up where that automation ends, providing a seamless continuation of the deployment workflow.

### Why a Separate Project?

1. **Separation of Concerns**: Satellite installation and Capsule installation are distinct phases with different requirements and timelines
2. **Flexibility**: Capsules can be installed independently after Satellite deployment is complete
3. **Reusability**: This project can work with any properly prepared Capsule servers, regardless of how they were provisioned
4. **Simplicity**: Focused scope makes the automation easier to understand, test, and maintain

## Architecture and Design Decisions

### Built for Ansible Automation Platform (AAP)

This project is designed exclusively for execution via Ansible Automation Platform. It expects:
- **Job Templates** assigned to inventories containing target Capsule servers
- **Credentials** injected at runtime through AAP credential management
- **Variables** defined in the repository's group_vars structure
- **Collections** pre-installed in the Execution Environment

### Host Targeting Strategy

The project uses a **validation-based targeting approach**:

```yaml
hosts: all  # Target all hosts provided by AAP inventory
```

Then validates each host against the `capsule_fqdns` variable:
```yaml
- name: Validate host is a designated Capsule
  ansible.builtin.assert:
    that:
      - inventory_hostname in capsule_fqdns
```

**Why this approach?**
- **Safety**: Prevents accidental execution on non-Capsule servers (including the Satellite)
- **Flexibility**: AAP provides a simple list of servers without requiring inventory groups
- **Consistency**: Matches the pattern used in the satellite install project
- **Validation**: The `capsule_fqdns` variable serves as the definitive source of truth

### Load Balancer Support

The automation automatically detects and handles load-balanced Capsule configurations by:
- Reading load balancer instructions from generated files
- Appending required parameters (`--certs-cname`, `--enable-foreman-proxy-plugin-remote-execution-script`)
- Validating certificate requirements include both Capsule FQDN and load balancer FQDN

### Red Hat Satellite Collection Usage

All Satellite API operations use the `redhat.satellite` collection exclusively:
- **Registration**: `redhat.satellite.registration_command` generates modern curl-based registration
- **Verification**: `redhat.satellite.host_info` and `redhat.satellite.capsule_info` confirm successful installation
- **No Direct API Calls**: Ensures compatibility and maintainability

**Why the collection approach?**
- **6.17 Compatibility**: Modern registration methods replace legacy katello-ca-consumer packages
- **Maintenance**: Red Hat maintains collection compatibility across versions
- **Features**: Collection modules provide better error handling and validation
- **Best Practice**: Official Red Hat recommended approach

### Simplified Prerequisites

This automation assumes the target servers were already prepared by the satellite-install project:
- **Storage configured**: LVM volumes already created and mounted
- **Packages updated**: System packages already current
- **Users created**: Service accounts already present
- **Certificates distributed**: Required files already in place at `/root/capsule_cert/`

**Why minimal prerequisites?**
- **No Duplication**: Avoids repeating work already done by satellite-install
- **Focused Scope**: Concentrates on Capsule-specific installation tasks
- **Reliability**: Builds on proven foundation from initial deployment

### Environment Management

The project supports multiple environments through:
- **Environment-specific playbooks**: `capsule-install-{env}.yml`
- **Environment-specific variables**: `group_vars/{env}_env.yml`
- **Inheritance**: All environments inherit base configuration from `group_vars/all.yml`

**Environment Examples**:
- **Development**: Single Capsule, verbose logging, shorter timeouts
- **Test**: Multiple Capsules, enhanced verification, faster feedback
- **Production**: Load-balanced Capsules, conservative timeouts, maintenance window prompts
- **EAD**: Placeholder for future expansion

## Installation Workflow

### Phase 1: Pre-Installation Cleanup
- Removes existing subscription registrations
- Cleans old katello-ca-consumer packages (legacy)
- Resets RHSM configuration to defaults
- Ensures base packages are present (failsafe)

### Phase 2: Capsule Registration
- Tests connectivity to Satellite server
- Generates registration command via Satellite API
- Registers using activation key `satellite-infrastructure`
- Enables remote execution, disables insights
- Verifies registration in Satellite

### Phase 3: Repository Configuration
- Disables all repositories
- Enables only required Capsule repositories
- Verifies satellite-capsule package availability
- Updates repository metadata

### Phase 4: Parse Installation Instructions
- Reads instruction file generated by satellite-install project
- Extracts satellite-installer command with OAuth keys
- Detects load balancer configuration requirements
- Appends load balancer parameters if needed
- Validates command completeness

### Phase 5: Capsule Installation
- Executes satellite-installer with proper async/poll handling
- Monitors installation progress (30-60 minutes typical)
- Verifies service startup and health
- Confirms Capsule registration in Satellite
- Tests Capsule API responsiveness

## Prerequisites

### From satellite install Project

Each target Capsule server must have these files already distributed:
- **Certificate tarball**: `/root/capsule_cert/<capsule_fqdn>-certs.tar`
- **Installation instructions**: `/root/capsule_cert/<capsule_fqdn>-install.txt`

### Satellite Configuration

The target Satellite must have:
- **Activation Key**: Named `satellite-infrastructure` with appropriate content view
- **Content Synchronization**: Required Capsule repositories synchronized from CDN
- **Organization**: Matching the `satellite_org` variable value
- **Network Access**: Direct connectivity from Capsules (no proxy for registration)

### Infrastructure Requirements

- **RHEL Version**: RHEL 9.x on all target servers
- **Resources**: Minimum 20GB RAM per Capsule server
- **Storage**: LVM volumes already configured by satellite-install project
- **DNS**: All Capsule FQDNs resolvable from Satellite
- **Certificates**: Custom SSL certificates must include load balancer FQDN in SAN (if applicable)

## Ansible Automation Platform Setup

### 1. Create Project in AAP

1. Navigate to **Projects** in AAP
2. Create new project pointing to this Git repository
3. Configure appropriate branch/tag for your environment
4. Enable project sync and update on launch

### 2. Configure Credentials

Create the following credential types in AAP:

**Machine Credential**: SSH access to target Capsule servers

**Custom Credential for Satellite API** (Type: Custom):
```yaml
Input Configuration:
fields:
  - id: app_username
    type: string
    label: Satellite Admin Username
  - id: app_password
    type: string
    label: Satellite Admin Password
    secret: true

Injector Configuration:
extra_vars:
  app_username: '{{ app_username }}'
  app_password: '{{ app_password }}'
```

### 3. Create Job Template

1. **Name**: "Install Satellite Capsules - {Environment}"
2. **Job Type**: Run
3. **Inventory**: Assign inventory containing target Capsule servers
4. **Project**: Select the project created above
5. **Playbook**: Choose environment-specific playbook:
   - `capsule-install.yml` (Development)
   - `capsule-install-test.yml` (Test)
   - `capsule-install-prod.yml` (Production)
   - `capsule-install-ead.yml` (EAD)
6. **Credentials**: 
   - Add Machine credential for SSH access
   - Add Custom credential for Satellite API access
7. **Options**: 
   - ✅ Privilege Escalation
   - ✅ Provision Callbacks (optional)

### 4. Inventory Requirements

**Important**: AAP inventory should contain only the target Capsule servers as a flat list. Do not create inventory groups - the playbook will validate each host against the `capsule_fqdns` variable defined in group_vars.

Example inventory:
```
testcapsule1.example.com
testcapsule2.example.com
```

### 5. Launch Job

1. Navigate to job template
2. Click **Launch**
3. Monitor progress (typical runtime: 45-60 minutes)
4. Review job output and logs

## Environment Customization

To adapt this project for your environment:

1. **Update group_vars files** with your specific:
   - Satellite FQDNs
   - Capsule FQDNs  
   - Load balancer configuration
   - Organization settings

2. **Modify timeout values** based on your infrastructure:
   - `capsule_installer_timeout`: Installation timeout
   - `registration_timeout`: Registration timeout
   - `capsule_health_check_*`: Health check parameters

3. **Adjust logging preferences**:
   - `capsule_debug_output`: Verbose logging control
   - `save_installation_logs`: Log retention settings

## Security Considerations

- **No Proxy Registration**: Capsules connect directly to Satellite (never through proxy)
- **Credential Management**: All sensitive data injected via AAP credentials
- **Certificate Validation**: Installation validates certificate integrity
- **OAuth Protection**: OAuth keys embedded in instruction files are protected
- **API-Only Operations**: No configuration changes made to Satellite server

## Troubleshooting

### Common Issues

**Registration Failures**:
- Verify activation key `satellite-infrastructure` exists and has correct content view
- Check network connectivity from Capsule to Satellite
- Confirm DNS resolution for Satellite FQDN

**Repository Issues**:
- Ensure required repositories are synchronized in Satellite
- Verify activation key provides access to Capsule repositories
- Check subscription entitlements include Capsule products

**Installation Failures**:
- Validate certificate files are present and correct
- For load-balanced Capsules, verify certificate SAN includes load balancer FQDN
- Check available disk space and system resources
- Review installation logs in `/var/log/capsule-installation/`

**Load Balancer Problems**:
- Confirm `loadbalanced_capsules` variable includes the Capsule FQDN
- Verify `capsule_loadbalancer_fqdn` is correctly configured
- Check that certificates include both Capsule and load balancer FQDNs

### Getting Help

1. **Check installation logs**: Detailed logs saved in `/var/log/capsule-installation/`
2. **Review AAP job output**: Full execution logs available in job details
3. **Validate prerequisites**: Ensure all certificate files are present and valid
4. **Verify configuration**: Check group_vars match your environment

## Performance Expectations

- **Duration**: 45-60 minutes typical for complete installation
- **Resource Usage**: Minimal impact on existing systems
- **Network**: Registration and content download traffic to Satellite
- **Storage**: Installation logs and certificates (minimal space required)

## Future Enhancements

This project establishes the foundation for additional Capsule automation:
- **Content Synchronization**: Automated sync setup from Satellite
- **Location Assignment**: Automatic assignment to appropriate locations
- **Host Group Configuration**: Template assignment for new systems
- **Monitoring Integration**: Health check and alerting setup

---

**Note**: This project is designed to work exclusively with Ansible Automation Platform and requires proper AAP setup including project configuration, credential management, and inventory assignment to job templates.